name: Restrict Issues

on:
  issues:
    types: [opened]

jobs:
  restrict-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Check issue creator
        uses: actions/github-script@v6
        with:
          script: |
            const authorizedUser = process.env.AUTHORIZED_USER; // Secrets에서 단일 사용자 가져오기
            const issueCreator = context.payload.issue.user.login; // 이슈 작성자 ID
            console.log(`Authorized User: ${authorizedUser}`);
            console.log(`Issue Creator: ${issueCreator}`);

            if (issueCreator !== authorizedUser) {
              console.log(`Unauthorized user: ${issueCreator}`);
              await github.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                state: 'closed',
                body: 'This issue has been closed because you are not authorized.'
              });
              return; // 작업 중단
            } else {
              console.log(`Authorized user: ${issueCreator}`);
            }
        env:
          AUTHORIZED_USER: ${{ secrets.AUTHORIZED_USER }}

      - name: Trigger Convert Issue Workflow
        if: ${{ success() }} # 작성자가 허가된 경우에만 실행
        run: |
          echo "Triggering Convert Issue Workflow..."
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/convert-issue-to-md.yml/dispatches \
            -d '{
              "ref": "main",
              "inputs": {
                "title": "${{ github.event.issue.title }}",
                "body": "${{ github.event.issue.body }}"
              }
            }'
